---
title: Raspberry Pi 3B+ ＋ PX-Q3U4 で録画サーバー ( 性能チェック )
---



## 目的
Raspberry Pi 3B+ ＋ PX-Q3U4 で録画サーバーを構築するために必要な能力があるか
チェックする。



## 条件

マシン     | Raspberry Pi 3B+
OS         | [Raspbian 4.14.79-v7+](https://www.raspberrypi.org)
チューナー | [PX-Q3U4](http://www.plex-net.co.jp/product/px-q3u4/)
ドライバー | [PX-Q3U4 用のドライバー](https://github.com/nns779/px4_drv)
HDD        | USB HDD 1TB。 dd での書き込み速度は 53.3 MB/s 程度
作業PC     | Ubuntu 18.04.1 LTS i5-3570 3.40GHz


------------------------
## テスト その１ 

1. recpt1 で 30分間録画をストリーム数だけ並列で実行する。
   ( コマンドは recpt1 --b25 Ch 1800 TSファイル名 )
1. 録画終了後 tsselect を実行し drop数をカウントする。
   ただしカウントは、パケット数の上位 10 番目までの PID に限定する。

結果

| ストリーム数       | データ量  |  drop数    |参考(作業PCでのdrop数)|
|--------------------|-----------+------------|----------------------|
| BS ×1             |   5.1GB   |      0     |     0                |
| BS ×2             |  10.2GB   |      0     |     0                |
| BS ×3             |  15.3GB   |      8     |    14                |
| BS ×4             |  20.5GB   |     46     |     2                |
| 地デジ×1          |   3.7GB   |      0     |    23                |
| 地デジ×2          |   7.4GB   |    153     |     8                |
| 地デジ×3          |  11.1GB   |      0     |    15                |
| 地デジ×4          |  14.8GB   |    212     |     7                |
| BS×2, 地デジ ×2  |  17.6GB   |      0     |    26                |
| BS×3, 地デジ ×2  |  22.7GB   |  53525     |  4069                |
| BS×3, 地デジ ×3  |  25.5GB   |  90080     |   530                |
| BS×4, 地デジ ×3  |  20.7GB   | 563133     |    13                |
| BS×4, 地デジ ×4  |  18.8GB   | 439943     |   394                |

* 目標である BS ×3 は、ギリギリでクリアとする。

* 地デジで drop 数が多いのは電波状況の為？

* recpt1 1個あたりのCPU負荷は RasPi で 20〜25% だが、
   ロードアベレージが、 BS×4, 地デジ ×4 では 9〜10 になり、
   CPUは余っているのに過負荷になっている。(4コアなので MAX は 400% )

* 作業PC(Ubuntu) に Plex社製のドライバーでも同じような傾向だったので、
  元のドライバーが悪いのか。




------------------------
## テスト その２

mirakurun + EPGStation をインストールし、BS×3 を 30分間録画し
drop 数をカウントする。

結果

 drop数は 10345 + 62 +  2023 = 12430

 top で CPU負荷状況をみると Mirakurun が 100% 以上となって過負荷になって、
 データを処理しきれなくなっている。(RasPi には荷が重い。)
 
```
  PID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND    
  748 root      10 -10  256916 145260   6660 R 107.6 15.3  16:07.67 Mirakurun:+
  918 shiiya    20   0  222872 100384   6760 S  14.2 10.6   0:20.79 node       
 1800 root      10 -10  105028  75252    208 D   9.9  7.9   0:09.03 recpt1     
 1798 root      10 -10  135892 106456    212 D   9.6 11.2   0:11.40 recpt1     
 1799 root      10 -10  159980 130552    236 D   7.3 13.8   0:10.69 recpt1     
  729 root      20   0  142432  28052   6220 S   2.0  3.0   0:17.08 PM2 v3.2.4+
```

------------------------
## テスト その３

epgrec UNA版 をインストールして、BS×3 を 30分間録画して、
drop 数をカウントする。

結果

 drop 0 + 0 + 0 = 0




------------------------
## 録画ソフトの選択

以上の結果から録画ソフトの選択は、下記のようになった。

| 名前                      | 判定 | コメント                                 |
|---------------------------|------|------------------------------------------|
| mirakurun + EPGStation    |  ×  | 3TS では Mirakurun が RasPi には荷が重い。|
| mirakurun + chinachu γ   |  ×  | 未テストだが、上と同じ筈                 |
| chinachu β               |  ×  | armはサポート外でインストール出来ず。    |
| epgrec UNA版              |  △  | 動くが、機能的に不足な所がある。         |
| epgrec STZ版              |  ×  | php7 では、動かない                      |
| epgrec 本家               |  ×  | 同上                                     |

* epgrec UNA版で運用する。
* Raspberry Pi でも動く、軽い録画ソフトが欲しい。
  ( → 2019/11/09 追記: [作りました。]({{site.baseurl}}/src/raspirec.html) )

